<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                  <!-- æµè§ˆå™¨æ ‡ç­¾å›¾æ ‡ -->
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<!-- PNG æ ¼å¼å¯ç”¨ -->
<link rel="icon" href="/favicon.png" type="image/png">
<!-- iOS æ¡Œé¢å›¾æ ‡ -->
<link rel="apple-touch-icon" href="/icon.png">
<!-- å¼ºåˆ¶ Web App æ¨¡å¼ -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="äº‘ç«¯è®°è´¦">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº‘ç«¯è®°è´¦</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 30px; text-align: center; color: white; position: relative; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .sync-status { position: absolute; top: 20px; right: 20px; display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.2); padding: 10px 15px; border-radius: 25px; font-size: 14px; }
        .sync-indicator { width: 10px; height: 10px; border-radius: 50%; background: #51cf66; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .user-info { background: rgba(255,255,255,0.1); padding: 15px 20px; border-radius: 15px; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; }
        .balance-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
        .balance-card { background: rgba(255,255,255,0.2); padding: 20px; border-radius: 15px; text-align: center; backdrop-filter: blur(10px); }
        .balance-card h3 { font-size: 0.9em; margin-bottom: 5px; opacity: 0.8; }
        .balance-amount { font-size: 1.8em; font-weight: bold; }
        .main-content { padding: 30px; }
        .tabs { display: flex; border-bottom: 2px solid #f0f0f0; margin-bottom: 30px; }
        .tab { padding: 15px 30px; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s; font-weight: bold; }
        .tab.active { color: #4facfe; border-bottom-color: #4facfe; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .form-container { background: #f8f9ff; padding: 25px; border-radius: 15px; margin-bottom: 30px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; }
        label { margin-bottom: 8px; font-weight: bold; color: #333; }
        input, select, textarea { padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 14px; transition: border-color 0.3s; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #4facfe; }
        .btn { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 12px 30px; border: none; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: bold; transition: transform 0.3s; width: 100%; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3); }
        .btn-small { width: auto; padding: 8px 20px; font-size: 14px; }
        .btn-danger { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%); }
        .btn-success { background: linear-gradient(135deg, #51cf66 0%, #40c057 100%); }
        .btn-warning { background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%); }
        .records-container { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .filters { padding: 20px; background: #f8f9ff; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; align-items: end; }
        .record-item { padding: 20px; border-bottom: 1px solid #f0f0f0; display: grid; grid-template-columns: auto 1fr auto auto auto; gap: 15px; align-items: center; transition: background-color 0.3s; }
        .record-item:hover { background-color: #f8f9ff; }
        .record-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .income-icon { background: linear-gradient(135deg, #51cf66 0%, #40c057 100%); color: white; }
        .expense-icon { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%); color: white; }
        .record-info { display: flex; flex-direction: column; gap: 5px; }
        .record-category { font-weight: bold; color: #333; display: flex; align-items: center; gap: 8px; }
        .record-desc { color: #666; font-size: 14px; }
        .record-date { color: #999; font-size: 12px; }
        .record-amount { font-size: 18px; font-weight: bold; }
        .income-amount { color: #51cf66; }
        .expense-amount { color: #ff6b6b; }
        .delete-btn { background: #ff6b6b; color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 12px; transition: background-color 0.3s; }
        .delete-btn:hover { background: #ee5a52; }
        .edit-btn { background: #ffc107; color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 12px; transition: background-color 0.3s; }
        .edit-btn:hover { background: #fd7e14; }
        .no-data { text-align: center; padding: 50px; color: #999; font-size: 16px; }
        .export-section { background: #f8f9ff; padding: 25px; border-radius: 15px; text-align: center; margin-bottom: 20px; }
        .export-title { font-size: 20px; font-weight: bold; margin-bottom: 15px; color: #333; }
        .export-options { display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; }
        .date-range-filter { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .loading { opacity: 0.6; pointer-events: none; }
        .form-buttons { display: flex; gap: 10px; }
        .cancel-edit { background: #6c757d; }
        .cancel-edit:hover { background: #5a6268; }
        
        /* æŠ¥è¡¨é¡µé¢ç‰¹å®šæ ·å¼ */
        .report-filters { 
            background: #f8f9ff; 
            padding: 25px; 
            border-radius: 15px; 
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .data-table th {
            background-color: #f8f9ff;
            font-weight: bold;
            color: #333;
        }
        
        .data-table tr:last-child td {
            border-bottom: none;
        }
        
        .income-row { color: #51cf66; }
        .expense-row { color: #ff6b6b; }
        
        .table-container {
            overflow-x: auto;
        }
        
        .time-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .time-filter-btn {
            padding: 8px 15px;
            background: #e9ecef;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .time-filter-btn.active {
            background: #4facfe;
            color: white;
        }
        
        .export-options {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #f0f0f0;
        }
        
        /* å…¶ä»–é€šç”¨æ ·å¼ */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        .toast.show {
            opacity: 1;
        }
        .toast.success { background-color: #51cf66; }
        .toast.error { background-color: #ff6b6b; }
        .toast.warning { background-color: #ffc107; }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255,255,255,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
            display: none;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4facfe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
           100% { transform: rotate(360deg); }
        }
        
        .search-box {
            grid-column: 1 / -1;
        }
        
        .sort-options {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            padding: 0 20px;
        }
        .sort-btn {
            padding: 8px 15px;
            background: #e9ecef;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .sort-btn.active {
            background: #4facfe;
            color: white;
        }
        
        .quick-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            padding: 0 20px;
            flex-wrap: wrap;
        }
        
        .filter-summary {
            padding: 10px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            font-size: 14px;
            color: #6c757d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .clear-filters {
            color: #4facfe;
            cursor: pointer;
            font-size: 13px;
        }
        
        .category-icon {
            font-size: 16px;
            width: 20px;
            text-align: center;
        }
        
        /* æŠ¥è¡¨é¡µé¢æŒ‰é’®å®¹å™¨ */
        .report-buttons {
            grid-column: 1 / -1;
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 10px;
        }
        
        /* å¤‡æ³¨å’ŒæŒ‰é’®ä¹‹é—´åŠ é—´è· */
        .form-group:last-of-type { margin-bottom: 10px; }
        
        /* å¯¼å‡ºé€‰é¡¹æ ·å¼ */
        .export-option-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            text-align: center;
            transition: transform 0.3s;
        }
        .export-option-card:hover {
            transform: translateY(-5px);
        }
        .export-icon {
            font-size: 2.5em;
            margin-bottom: 15px;
            color: #4facfe;
        }
        .export-option-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .export-option-desc {
            color: #666;
            margin-bottom: 15px;
            font-size: 0.9em;
        }
        
        @media (max-width: 768px) {
            .container { margin: 0; border-radius: 0; }
            .main-content { padding: 20px; }
            .form-grid { grid-template-columns: 1fr; }
            .balance-info { grid-template-columns: 1fr; }
            .record-item { grid-template-columns: auto 1fr auto; gap: 10px; }
            .delete-btn, .edit-btn { grid-row: 1; }
            .sync-status { position: static; margin-bottom: 15px; justify-content: center; }
            .form-buttons { flex-direction: column; }
            .filters { grid-template-columns: 1fr; }
            .report-filters { grid-template-columns: 1fr; }
            .quick-filters, .sort-options {
                padding: 0 10px;
            }
            .report-buttons {
                flex-direction: column;
                align-items: stretch;
            }
            .export-options {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>
    
    <div class="toast" id="toast"></div>
    
    <div class="container">
        <div class="header">
            <div class="sync-status">
                <div class="sync-indicator" id="syncIndicator"></div>
                <span id="syncStatusText">äº‘ç«¯å·²åŒæ­¥</span>
            </div>
            <h1>â˜ï¸ äº‘ç«¯è®°è´¦</h1>
            <div class="user-info" id="userInfo" style="display: none;">
                <span>ğŸ‘¤ğŸ‘¤ ç”¨æˆ·ï¼š<span id="currentUser">å•äººä½¿ç”¨</span></span>
            </div>
            <div class="balance-info">
                <div class="balance-card">
                    <h3>æ€»ä½™é¢</h3>
                    <div class="balance-amount" id="totalBalance">ï¿¥0.00</div>
                </div>
                <div class="balance-card">
                    <h3>æœ¬æœˆæ”¶å…¥</h3>
                    <div class="balance-amount income-amount" id="monthIncome">ï¿¥0.00</div>
                </div>
                <div class="balance-card">
                    <h3>æœ¬æœˆæ”¯å‡º</h3>
                    <div class="balance-amount expense-amount" id="monthExpense">ï¿¥0.00</div>
                </div>
            </div>
        </div>

        <div id="appSection" class="main-content">
            <div class="tabs">
                <div class="tab active" onclick="switchTab('add')"> è®°è´¦</div>
                <div class="tab" onclick="switchTab('records')"> è´¦å•</div>
                <div class="tab" onclick="switchTab('export')"> æŠ¥è¡¨</div>
            </div>

            <!-- è®°è´¦é¡µé¢ -->
            <div id="add-tab" class="tab-content active">
                <div class="form-container">
                    <form id="expenseForm">
                        <input type="hidden" id="editId" value="">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>ç±»å‹</label>
                                <select id="type" required>
                                    <option value="expense">æ”¯å‡º</option>
                                    <option value="income">æ”¶å…¥</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>é‡‘é¢</label>
                                <input type="number" id="amount" step="0.01" placeholder="è¾“å…¥é‡‘é¢" required min="0.01">
                            </div>
                            <div class="form-group">
                                <label>åˆ†ç±»</label>
                                <select id="category" required>
                                    <option value="">è¯·é€‰æ‹©åˆ†ç±»</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>æ—¥æœŸ</label>
                                <input type="date" id="date" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>å¤‡æ³¨</label>
                            <textarea id="description" placeholder="æ·»åŠ å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰" rows="2" maxlength="100"></textarea>
                            <div style="text-align: right; font-size: 12px; color: #999;">
                                <span id="charCount">0</span>/100
                            </div>
                        </div>
                        <div class="form-buttons">
                            <button type="submit" class="btn" id="submitBtn">ğŸ’¾ æ·»åŠ è®°å½•</button>
                            <button type="button" class="btn cancel-edit" id="cancelEditBtn" style="display: none;">å–æ¶ˆä¿®æ”¹</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- è´¦å•é¡µé¢ -->
            <div id="records-tab" class="tab-content">
                <div class="records-container">
                    <div class="filters">
                        <div class="form-group search-box">
                            <label>æœç´¢</label>
                            <input type="text" id="searchInput" placeholder="æœç´¢åˆ†ç±»æˆ–å¤‡æ³¨..." oninput="filterRecords()">
                        </div>
                        <div class="form-group">
                            <label>ç±»å‹ç­›é€‰</label>
                            <select id="filterType" onchange="filterRecords()">
                                <option value="all">å…¨éƒ¨</option>
                                <option value="income">æ”¶å…¥</option>
                                <option value="expense">æ”¯å‡º</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>å¼€å§‹æ—¥æœŸ</label>
                            <input type="date" id="recordStartDate" onchange="filterRecords()">
                        </div>
                        <div class="form-group">
                            <label>ç»“æŸæ—¥æœŸ</label>
                            <input type="date" id="recordEndDate" onchange="filterRecords()">
                        </div>
                        <div class="form-group" style="display: flex; align-items: end;">
                            <button class="btn btn-small" onclick="clearRecordDateFilter()">æ¸…é™¤ç­›é€‰</button>
                        </div>
                    </div>
                    
                    <div class="filter-summary" id="filterSummary">
                        <span>æ˜¾ç¤ºå…¨éƒ¨è®°å½•</span>
                        <span class="clear-filters" onclick="clearAllFilters()">æ¸…é™¤æ‰€æœ‰ç­›é€‰</span>
                    </div>
                    
                    <div style="padding: 10px 0; background: #f8f9fa;">
                        <div class="quick-filters">
                            <button class="time-filter-btn" onclick="setQuickFilter('today')">
                                <i class="fas fa-calendar-day"></i> ä»Šå¤©
                            </button>
                            <button class="time-filter-btn" onclick="setQuickFilter('week')">
                                <i class="fas fa-calendar-week"></i> æœ¬å‘¨
                            </button>
                            <button class="time-filter-btn" onclick="setQuickFilter('month')">
                                <i class="fas fa-calendar"></i> æœ¬æœˆ
                            </button>
                            <button class="time-filter-btn" onclick="setQuickFilter('lastMonth')">
                                <i class="fas fa-calendar-minus"></i> ä¸Šæœˆ
                            </button>
                        </div>
                        
                        <div class="sort-options">
                            <button class="sort-btn" onclick="sortRecords('date', 'desc')" id="sortDateDesc">
                                <i class="fas fa-sort-amount-down-alt"></i> æ—¥æœŸâ†“
                            </button>
                            <button class="sort-btn" onclick="sortRecords('date', 'asc')" id="sortDateAsc">
                                <i class="fas fa-sort-amount-up"></i> æ—¥æœŸâ†‘
                            </button>
                            <button class="sort-btn" onclick="sortRecords('amount', 'desc')" id="sortAmountDesc">
                                <i class="fas fa-sort-amount-down-alt"></i> é‡‘é¢â†“
                            </button>
                            <button class="sort-btn" onclick="sortRecords('amount', 'asc')" id="sortAmountAsc">
                                <i class="fas fa-sort-amount-up"></i> é‡‘é¢â†‘
                            </button>
                        </div>
                    </div>
                    
                    <div id="recordsList"></div>
                </div>
            </div>

            <!-- æŠ¥è¡¨ä¸å¯¼å‡ºé¡µé¢ -->
            <div id="export-tab" class="tab-content">
                <div class="report-filters">
                    <div class="form-group">
                        <label>å¼€å§‹æ—¥æœŸ</label>
                        <input type="date" id="reportStartDate">
                    </div>
                    <div class="form-group">
                        <label>ç»“æŸæ—¥æœŸ</label>
                        <input type="date" id="reportEndDate">
                    </div>
                    <div class="form-group">
                        <label>ç±»å‹ç­›é€‰</label>
                        <select id="reportTypeFilter">
                            <option value="all">å…¨éƒ¨</option>
                            <option value="income">æ”¶å…¥</option>
                            <option value="expense">æ”¯å‡º</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>åˆ†ç±»ç­›é€‰</label>
                        <select id="reportCategoryFilter">
                            <option value="all">å…¨éƒ¨åˆ†ç±»</option>
                        </select>
                    </div>
                    <div class="report-buttons">
                        <button class="btn btn-small" onclick="applyReportFilters()">åº”ç”¨ç­›é€‰</button>
                        <button class="btn btn-small" style="background: #6c757d;" onclick="resetReportFilters()">é‡ç½®</button>
                    </div>
                </div>
                
                <div class="time-filter">
                    <button class="time-filter-btn" onclick="setReportTimeFilter('today')">
                        <i class="fas fa-calendar-day"></i> ä»Šå¤©
                    </button>
                    <button class="time-filter-btn" onclick="setReportTimeFilter('week')">
                        <i class="fas fa-calendar-week"></i> æœ¬å‘¨
                    </button>
                    <button class="time-filter-btn" onclick="setReportTimeFilter('month')">
                        <i class="fas fa-calendar"></i> æœ¬æœˆ
                    </button>
                    <button class="time-filter-btn" onclick="setReportTimeFilter('lastMonth')">
                        <i class="fas fa-calendar-minus"></i> ä¸Šæœˆ
                    </button>
                    <button class="time-filter-btn" onclick="setReportTimeFilter('year')">
                        <i class="fas fa-calendar-alt"></i> ä»Šå¹´
                    </button>
                    <button class="time-filter-btn" onclick="setReportTimeFilter('all')">
                        <i class="fas fa-infinity"></i> å…¨éƒ¨
                    </button>
                </div>
                
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>æ—¥æœŸ</th>
                                <th>ç±»å‹</th>
                                <th>åˆ†ç±»</th>
                                <th>é‡‘é¢</th>
                                <th>å¤‡æ³¨</th>
                            </tr>
                        </thead>
                        <tbody id="reportDataTable">
                            <!-- æ•°æ®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>
                
                <div class="export-options">
                    <div class="export-option-card">
                        <div class="export-icon">
                            <i class="fas fa-file-excel"></i>
                        </div>
                        <div class="export-option-title">å¯¼å‡ºExcel</div>
                        <div class="export-option-desc">å°†æ•°æ®å¯¼å‡ºä¸ºExcelè¡¨æ ¼ï¼Œæ–¹ä¾¿è¿›ä¸€æ­¥åˆ†æ</div>
                        <button class="btn btn-success" onclick="exportExcel()">
                            <i class="fas fa-file-excel"></i> å¯¼å‡ºExcel
                        </button>
                    </div>
                    
                    <div class="export-option-card">
                        <div class="export-icon">
                            <i class="fas fa-file-pdf"></i>
                        </div>
                        <div class="export-option-title">å¯¼å‡ºPDF</div>
                        <div class="export-option-desc">ç”Ÿæˆæ ¼å¼åŒ–çš„PDFæ–‡æ¡£ï¼Œé€‚åˆæ‰“å°å’Œå­˜æ¡£</div>
                        <button class="btn btn-success" onclick="exportPDF()">
                            <i class="fas fa-file-pdf"></i> å¯¼å‡ºPDF
                        </button>
                    </div>
                    
                    <div class="export-option-card">
                        <div class="export-icon">
                            <i class="fas fa-file-export"></i>
                        </div>
                        <div class="export-option-title">å¤‡ä»½æ•°æ®</div>
                        <div class="export-option-desc">å°†æ•°æ®å¤‡ä»½ä¸ºJSONæ–‡ä»¶ï¼Œæ–¹ä¾¿è¿ç§»å’Œæ¢å¤</div>
                        <button class="btn btn-warning" onclick="exportJSON()">
                            <i class="fas fa-file-export"></i> å¤‡ä»½æ•°æ®(JSON)
                        </button>
                    </div>
                </div>

                <div style="margin-top: 30px; padding: 20px; background: #f8f9ff; border-radius: 15px;">
                    <h3 style="margin-bottom: 15px; text-align: center;">æ•°æ®å¯¼å…¥</h3>
                    <div style="display: flex; flex-direction: column; align-items: center;">
                        <input type="file" id="importFile" accept=".json,.xlsx,.xls" style="margin-bottom: 15px;">
                        <button class="btn btn-small" onclick="importData()">å¯¼å…¥æ•°æ®</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
<script>
// å…¨å±€å˜é‡
let records = [];
let filteredReportData = [];
let isEditing = false;
let currentSort = { field: 'date', direction: 'desc' };
let activeCategoryFilter = 'all';
let activeQuickFilter = '';

// åˆ†ç±»å›¾æ ‡æ˜ å°„
const categoryIcons = {
    // æ”¶å…¥
    'å·¥èµ„': 'fa-money-bill-wave',
    'æŠ•èµ„': 'fa-chart-line',
    'å…¼èŒ': 'fa-briefcase',
    'å…¶å®ƒ': 'fa-gift',
    // æ”¯å‡º
    'æ·˜å®': 'fa-shopping-cart',
    'çº¿ä¸‹': 'fa-store',
    'å¾®ä¿¡': 'fa-comment',
    '1688': 'fa-industry',
    'æ‹¼å¤šå¤š': 'fa-shopping-basket',
    'è¿è´¹': 'fa-truck',
    'éª‘å…µåˆ°å®¶å®‰è£…è´¹': 'fa-tools',
    'çº¿ä¸‹å®‰è£…è´¹': 'fa-tools',
    'æŠ–åº—': 'fa-mobile-alt',
    'å’¸é±¼': 'fa-fish',
    'ç»´ä¿®å·®æ—…è´¹': 'fa-car',
    'å…¶å®ƒ': 'fa-coins',
    // æ–°å¢åˆ†ç±»
    'äº¤é€š': 'fa-bus',
    'é¤é¥®': 'fa-utensils',
    'è´­ç‰©': 'fa-shopping-bag',
    'å¨±ä¹': 'fa-gamepad',
    'å…¶ä»–': 'fa-coins'
};

// åˆ†ç±»
const categories = {
    expense: ['æ·˜å®', 'çº¿ä¸‹', 'å¾®ä¿¡', '1688', 'æ‹¼å¤šå¤š', 'è¿è´¹', 'éª‘å…µåˆ°å®¶å®‰è£…è´¹', 'çº¿ä¸‹å®‰è£…è´¹', 'æŠ–åº—', 'å’¸é±¼', 'ç»´ä¿®å·®æ—…è´¹', 'äº¤é€š', 'é¤é¥®', 'è´­ç‰©', 'å¨±ä¹', 'å…¶ä»–',],
    income: ['å·¥èµ„', 'æŠ•èµ„', 'å…¼èŒ', 'å…¶ä»–']
};

// APIåŸºç¡€URL
const API_BASE = window.location.origin + window.location.pathname.replace('index.html', '');
const API_URL = API_BASE + 'data.php';

// åˆå§‹åŒ–
async function init() {
    await loadData();
    updateCategories();
    setTodayDate();
    setupEventListeners();
    updateCharCount();
    
    // å–æ¶ˆç¼–è¾‘æŒ‰é’®äº‹ä»¶
    document.getElementById('cancelEditBtn').addEventListener('click', cancelEdit);
}
init();

function setupEventListeners() {
    // å­—ç¬¦è®¡æ•°
    document.getElementById('description').addEventListener('input', updateCharCount);
}

function updateCharCount() {
    const textarea = document.getElementById('description');
    const charCount = document.getElementById('charCount');
    charCount.textContent = textarea.value.length;
}

function setTodayDate() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('date').value = today;
    document.getElementById('reportStartDate').value = today;
    document.getElementById('reportEndDate').value = today;
}

function updateCategories() {
    const typeSelect = document.getElementById('type');
    const categorySelect = document.getElementById('category');
    function refreshCategories() {
        const selectedType = typeSelect.value;
        categorySelect.innerHTML = '<option value="">è¯·é€‰æ‹©åˆ†ç±»</option>';
        categories[selectedType].forEach(cat => {
            let opt = document.createElement('option');
            opt.value = cat;
            opt.textContent = cat;
            
            // æ·»åŠ å›¾æ ‡åˆ°é€‰é¡¹
            if (categoryIcons[cat]) {
                opt.setAttribute('data-icon', categoryIcons[cat]);
            }
            
            categorySelect.appendChild(opt);
        });
    }
    typeSelect.addEventListener('change', refreshCategories);
    refreshCategories();
}

// æ ‡ç­¾é¡µåˆ‡æ¢
function switchTab(tabName) {
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById(tabName + '-tab').classList.add('active');
    
    if (tabName === 'records') {
        updateFilterSummary();
    } else if (tabName === 'export') {
        updateReportCategoryFilter();
        generateReport();
    }
}

// è¡¨å•æäº¤
document.getElementById('expenseForm').addEventListener('submit', async function(e){
    e.preventDefault();
    
    const type = document.getElementById('type').value;
    const amount = parseFloat(document.getElementById('amount').value);
    const category = document.getElementById('category').value;
    const date = document.getElementById('date').value;
    const description = document.getElementById('description').value;
    const editId = document.getElementById('editId').value;

    // æ•°æ®éªŒè¯
    if (amount <= 0) {
        showToast('é‡‘é¢å¿…é¡»å¤§äº0', 'error');
        return;
    }
    
    if (!category) {
        showToast('è¯·é€‰æ‹©åˆ†ç±»', 'error');
        return;
    }
    
    if (!date) {
        showToast('è¯·é€‰æ‹©æ—¥æœŸ', 'error');
        return;
    }

    showLoading(true);
    updateSyncStatus('syncing');
    
    if (isEditing && editId) {
        // æ›´æ–°è®°å½•
        const record = { id: parseInt(editId), type, amount, category, date, description };
        await updateRecord(record);
    } else {
        // æ·»åŠ æ–°è®°å½•
        const record = { type, amount, category, date, description };
        await addRecord(record);
    }

    resetForm();
    showLoading(false);
    updateSyncStatus('success');
});

// æ·»åŠ è®°å½•
async function addRecord(record) {
    try {
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(record)
        });
        
        const result = await response.json();
        
        if (result.success) {
            // æ·»åŠ è®°å½•åˆ°æœ¬åœ°æ•°ç»„
            record.id = result.id;
            records.unshift(record);
            updateDisplay();
            showToast('è®°å½•æ·»åŠ æˆåŠŸ');
        } else {
            throw new Error(result.error);
        }
    } catch (error) {
        console.error('æ·»åŠ è®°å½•å¤±è´¥:', error);
        showToast('æ·»åŠ è®°å½•å¤±è´¥: ' + error.message, 'error');
        updateSyncStatus('error', error.message);
    }
}

// æ›´æ–°è®°å½•
async function updateRecord(record) {
    try {
        const response = await fetch(API_URL, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(record)
        });
        
        const result = await response.json();
        
        if (result.success) {
            // æ›´æ–°æœ¬åœ°è®°å½•
            const index = records.findIndex(r => r.id === record.id);
            if (index !== -1) {
                records[index] = record;
            }
            
            updateDisplay();
            showToast('è®°å½•æ›´æ–°æˆåŠŸ');
        } else {
            throw new Error(result.error);
        }
    } catch (error) {
        console.error('æ›´æ–°è®°å½•å¤±è´¥:', error);
        showToast('æ›´æ–°è®°å½•å¤±è´¥: ' + error.message, 'error');
        updateSyncStatus('error', error.message);
    }
}

// é‡ç½®è¡¨å•
function resetForm() {
    document.getElementById('expenseForm').reset();
    document.getElementById('editId').value = '';
    setTodayDate();
    isEditing = false;
    document.getElementById('submitBtn').textContent = 'ğŸ’¾ æ·»åŠ è®°å½•';
    document.getElementById('cancelEditBtn').style.display = 'none';
    updateCharCount();
}

// å–æ¶ˆç¼–è¾‘
function cancelEdit() {
    resetForm();
    showToast('å·²å–æ¶ˆç¼–è¾‘', 'warning');
}

// ç¼–è¾‘è®°å½•
function editRecord(id) {
    const record = records.find(r => r.id === id);
    if (!record) return;
    
    document.getElementById('editId').value = record.id;
    document.getElementById('type').value = record.type;
    document.getElementById('amount').value = record.amount;
    document.getElementById('category').value = record.category;
    document.getElementById('date').value = record.date;
    document.getElementById('description').value = record.description || '';
    
    // æ›´æ–°åˆ†ç±»é€‰é¡¹
    updateCategories();
    
    isEditing = true;
    document.getElementById('submitBtn').textContent = 'ğŸ’¾ æ›´æ–°è®°å½•';
    document.getElementById('cancelEditBtn').style.display = 'block';
    updateCharCount();
    
    // åˆ‡æ¢åˆ°æ·»åŠ æ ‡ç­¾é¡µ
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    document.querySelector('.tab').classList.add('active');
    document.getElementById('add-tab').classList.add('active');
    
    // æ»šåŠ¨åˆ°è¡¨å•
    document.getElementById('expenseForm').scrollIntoView({ behavior: 'smooth' });
    
    showToast('æ­£åœ¨ç¼–è¾‘è®°å½•', 'warning');
}

// æ˜¾ç¤ºè®°å½•
function displayRecords(filteredRecords = records) {
    const list = document.getElementById('recordsList');
    
    // åº”ç”¨æ’åº
    filteredRecords.sort((a, b) => {
        let valueA, valueB;
        
        if (currentSort.field === 'date') {
            valueA = new Date(a.date);
            valueB = new Date(b.date);
        } else {
            valueA = a.amount;
            valueB = b.amount;
        }
        
        if (currentSort.direction === 'asc') {
            return valueA > valueB ? 1 : -1;
        } else {
            return valueA < valueB ? 1 : -1;
        }
    });
    
    if(filteredRecords.length === 0){
        list.innerHTML = '<div class="no-data">æš‚æ— è®°å½•æ•°æ®</div>';
        return;
    }
    
    list.innerHTML = filteredRecords.map(r => {
        const iconClass = r.type === 'income' ? 'income-icon' : 'expense-icon';
        const amountClass = r.type === 'income' ? 'income-amount' : 'expense-amount';
        const categoryIcon = categoryIcons[r.category] || (r.type === 'income' ? 'fa-money-bill-wave' : 'fa-shopping-cart');
        
        return `
        <div class="record-item" data-id="${r.id}">
            <div class="record-icon ${iconClass}">
                <i class="fas ${categoryIcon}"></i>
            </div>
            <div class="record-info">
                <div class="record-category">
                    <i class="fas ${categoryIcon}"></i> ${r.category}
                </div>
                <div class="record-desc">${r.description || 'æ— å¤‡æ³¨'}</div>
                <div class="record-date">${r.date}</div>
            </div>
            <div class="record-amount ${amountClass}">${r.type === 'income' ? '+' : '-'}ï¿¥${r.amount.toFixed(2)}</div>
            <button class="edit-btn" onclick="editRecord(${r.id})">ä¿®æ”¹</button>
            <button class="delete-btn" onclick="deleteRecord(${r.id})">åˆ é™¤</button>
        </div>`;
    }).join('');
}

// åˆ é™¤è®°å½•
async function deleteRecord(id) {
    if(confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
        showLoading(true);
        updateSyncStatus('syncing');
        
        try {
            const response = await fetch(`${API_URL}?id=${id}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (result.success) {
                // ä»æœ¬åœ°æ•°ç»„ä¸­ç§»é™¤è®°å½•
                records = records.filter(r => r.id !== id);
                updateDisplay();
                showToast('è®°å½•å·²åˆ é™¤');
            } else {
                throw new Error(result.error);
            }
        } catch (error) {
            console.error('åˆ é™¤è®°å½•å¤±è´¥:', error);
            showToast('åˆ é™¤è®°å½•å¤±è´¥: ' + error.message, 'error');
            updateSyncStatus('error', error.message);
        } finally {
            showLoading(false);
            updateSyncStatus('success');
        }
    }
}

// æ›´æ–°ç­›é€‰æ‘˜è¦
function updateFilterSummary() {
    const summary = document.getElementById('filterSummary');
    let text = 'æ˜¾ç¤ºå…¨éƒ¨è®°å½•';
    
    if (activeQuickFilter) {
        text = `æ˜¾ç¤º${getQuickFilterText(activeQuickFilter)}çš„è®°å½•`;
    } else if (activeCategoryFilter !== 'all') {
        text = `æ˜¾ç¤º"${activeCategoryFilter}"åˆ†ç±»çš„è®°å½•`;
    } else if (document.getElementById('filterType').value !== 'all') {
        const typeText = document.getElementById('filterType').value === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º';
        text = `æ˜¾ç¤º${typeText}è®°å½•`;
    } else if (document.getElementById('recordStartDate').value || document.getElementById('recordEndDate').value) {
        text = 'æ˜¾ç¤ºç­›é€‰æ—¥æœŸèŒƒå›´å†…çš„è®°å½•';
    } else if (document.getElementById('searchInput').value) {
        text = `æ˜¾ç¤ºåŒ…å«"${document.getElementById('searchInput').value}"çš„è®°å½•`;
    }
    
    summary.querySelector('span:first-child').textContent = text;
}

// è·å–å¿«é€Ÿç­›é€‰æ–‡æœ¬
function getQuickFilterText(filter) {
    switch(filter) {
        case 'today': return 'ä»Šå¤©';
        case 'week': return 'æœ¬å‘¨';
        case 'month': return 'æœ¬æœˆ';
        case 'lastMonth': return 'ä¸Šæœˆ';
        default: return '';
    }
}

// è®¾ç½®å¿«é€Ÿç­›é€‰
function setQuickFilter(filter) {
    activeQuickFilter = filter;
    const today = new Date();
    let startDate, endDate;
    
    switch(filter) {
        case 'today':
            startDate = endDate = today.toISOString().split('T')[0];
            break;
        case 'week':
            startDate = new Date(today.setDate(today.getDate() - today.getDay()));
            endDate = new Date(today.setDate(today.getDate() - today.getDay() + 6));
            startDate = startDate.toISOString().split('T')[0];
            endDate = endDate.toISOString().split('T')[0];
            break;
        case 'month':
            startDate = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
            endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];
            break;
        case 'lastMonth':
            startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1).toISOString().split('T')[0];
            endDate = new Date(today.getFullYear(), today.getMonth(), 0).toISOString().split('T')[0];
            break;
    }
    
    document.getElementById('recordStartDate').value = startDate;
    document.getElementById('recordEndDate').value = endDate;
    
    // æ¸…é™¤å…¶ä»–ç­›é€‰
    document.getElementById('filterType').value = 'all';
    document.getElementById('searchInput').value = '';
    activeCategoryFilter = 'all';
    
    filterRecords();
    updateFilterSummary();
}

// æ¸…é™¤æ‰€æœ‰ç­›é€‰
function clearAllFilters() {
    document.getElementById('recordStartDate').value = '';
    document.getElementById('recordEndDate').value = '';
    document.getElementById('filterType').value = 'all';
    document.getElementById('searchInput').value = '';
    activeCategoryFilter = 'all';
    activeQuickFilter = '';
    filterRecords();
    updateFilterSummary();
    showToast('å·²æ¸…é™¤æ‰€æœ‰ç­›é€‰', 'warning');
}

// æ¸…é™¤è´¦å•é¡µé¢çš„æ—¥æœŸç­›é€‰
function clearRecordDateFilter() {
    document.getElementById('recordStartDate').value = '';
    document.getElementById('recordEndDate').value = '';
    filterRecords();
}

// ç­›é€‰è®°å½•
function filterRecords() {
    const typeFilter = document.getElementById('filterType').value;
    const startDate = document.getElementById('recordStartDate').value;
    const endDate = document.getElementById('recordEndDate').value;
    const searchText = document.getElementById('searchInput').value.toLowerCase();
    
    let filtered = [...records];
    
    // ç±»å‹ç­›é€‰
    if(typeFilter !== 'all') {
        filtered = filtered.filter(r => r.type === typeFilter);
    }
    
    // åˆ†ç±»ç­›é€‰
    if(activeCategoryFilter !== 'all') {
        filtered = filtered.filter(r => r.category === activeCategoryFilter);
    }
    
    // æ—¥æœŸèŒƒå›´ç­›é€‰
    if(startDate || endDate) {
        filtered = filtered.filter(r => {
            const recordDate = r.date;
            const afterStart = !startDate || recordDate >= startDate;
            const beforeEnd = !endDate || recordDate <= endDate;
            return afterStart && beforeEnd;
        });
    }
    
    // æœç´¢ç­›é€‰
    if(searchText) {
        filtered = filtered.filter(r => 
            r.category.toLowerCase().includes(searchText) || 
            (r.description && r.description.toLowerCase().includes(searchText))
        );
    }
    
    displayRecords(filtered);
    updateFilterSummary();
}

// æ’åºè®°å½•
function sortRecords(field, direction) {
    currentSort = { field, direction };
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    document.querySelectorAll('.sort-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.getElementById(`sort${field.charAt(0).toUpperCase() + field.slice(1)}${direction === 'asc' ? 'Asc' : 'Desc'}`).classList.add('active');
    
    filterRecords(); // é‡æ–°åº”ç”¨ç­›é€‰å’Œæ’åº
}

// æ›´æ–°ä½™é¢
function updateBalance(){
    const currentMonth = new Date().toISOString().slice(0,7);
    let total=0, income=0, expense=0;
    records.forEach(r=>{
        total += r.type==='income'?r.amount:-r.amount;
        if(r.date.slice(0,7)===currentMonth){
            if(r.type==='income') income+=r.amount;
            else expense+=r.amount;
        }
    });
    document.getElementById('totalBalance').textContent = `ï¿¥${total.toFixed(2)}`;
    document.getElementById('monthIncome').textContent = `ï¿¥${income.toFixed(2)}`;
    document.getElementById('monthExpense').textContent = `ï¿¥${expense.toFixed(2)}`;
}

// æ›´æ–°æ˜¾ç¤º
function updateDisplay(){
    displayRecords();
    updateBalance();
}

// è¯»å–æ•°æ®
async function loadData(){
    try{
        const response = await fetch(API_URL);
        records = await response.json();
        updateDisplay();
        updateReportCategoryFilter();
    } catch(e){
        console.error('è¯»å–æ•°æ®å¤±è´¥:', e);
        showToast('è¯»å–æ•°æ®å¤±è´¥: ' + e.message, 'error');
        records = [];
    }
}

// æ˜¾ç¤ºToastæ¶ˆæ¯
function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = `toast show ${type}`;
    
    setTimeout(() => {
        toast.className = 'toast';
    }, 3000);
}

// æ˜¾ç¤ºåŠ è½½ä¸­
function showLoading(show) {
    document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
}

// æ›´æ–°åŒæ­¥çŠ¶æ€
function updateSyncStatus(status, message) {
    const indicator = document.getElementById('syncIndicator');
    const statusText = document.getElementById('syncStatusText');
    
    indicator.className = 'sync-indicator';
    if (status === 'syncing') {
        indicator.classList.add('syncing');
        statusText.textContent = 'åŒæ­¥ä¸­...';
    } else if (status === 'error') {
        indicator.classList.add('error');
        statusText.textContent = message || 'åŒæ­¥å¤±è´¥';
    } else {
        statusText.textContent = 'äº‘ç«¯å·²åŒæ­¥';
    }
}

// æŠ¥è¡¨ç›¸å…³åŠŸèƒ½
function updateReportCategoryFilter() {
    const categoryFilter = document.getElementById('reportCategoryFilter');
    categoryFilter.innerHTML = '<option value="all">å…¨éƒ¨åˆ†ç±»</option>';
    
    // è·å–æ‰€æœ‰å”¯ä¸€çš„åˆ†ç±»
    const allCategories = [...new Set(records.map(r => r.category))];
    allCategories.sort().forEach(cat => {
        let opt = document.createElement('option');
        opt.value = cat;
        opt.textContent = cat;
        categoryFilter.appendChild(opt);
    });
}

// åº”ç”¨æŠ¥è¡¨ç­›é€‰
function applyReportFilters() {
    generateReport();
}

// é‡ç½®æŠ¥è¡¨ç­›é€‰
function resetReportFilters() {
    document.getElementById('reportTypeFilter').value = 'all';
    document.getElementById('reportCategoryFilter').value = 'all';
    setDefaultReportDates();
    generateReport();
}

// è®¾ç½®æŠ¥è¡¨æ—¶é—´ç­›é€‰
function setReportTimeFilter(range) {
    const today = new Date();
    let startDate, endDate;
    
    switch(range) {
        case 'today':
            startDate = endDate = today.toISOString().split('T')[0];
            break;
        case 'week':
            startDate = new Date(today.setDate(today.getDate() - today.getDay()));
            endDate = new Date(today.setDate(today.getDate() - today.getDay() + 6));
            startDate = startDate.toISOString().split('T')[0];
            endDate = endDate.toISOString().split('T')[0];
            break;
        case 'month':
            startDate = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
            endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];
            break;
        case 'lastMonth':
            startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1).toISOString().split('T')[0];
            endDate = new Date(today.getFullYear(), today.getMonth(), 0).toISOString().split('T')[0];
            break;
        case 'year':
            startDate = new Date(today.getFullYear(), 0, 1).toISOString().split('T')[0];
            endDate = new Date(today.getFullYear(), 11, 31).toISOString().split('T')[0];
            break;
        case 'all':
            // è·å–æ‰€æœ‰è®°å½•çš„æœ€æ—©å’Œæœ€æ™šæ—¥æœŸ
            if (records.length > 0) {
                const dates = records.map(r => r.date).sort();
                startDate = dates[0];
                endDate = dates[dates.length - 1];
            } else {
                startDate = new Date().toISOString().split('T')[0];
                endDate = startDate;
            }
            break;
    }
    
    document.getElementById('reportStartDate').value = startDate;
    document.getElementById('reportEndDate').value = endDate;
    generateReport();
}

function setDefaultReportDates() {
    const today = new Date().toISOString().split('T')[0];
    // è®¾ç½®å¼€å§‹æ—¥æœŸä¸ºå½“æœˆç¬¬ä¸€å¤©
    const firstDay = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
    document.getElementById('reportStartDate').value = firstDay;
    document.getElementById('reportEndDate').value = today;
}

// ç”ŸæˆæŠ¥è¡¨
function generateReport() {
    const startDate = document.getElementById('reportStartDate').value;
    const endDate = document.getElementById('reportEndDate').value;
    const typeFilter = document.getElementById('reportTypeFilter').value;
    const categoryFilter = document.getElementById('reportCategoryFilter').value;
    
    // ç­›é€‰æ•°æ®
    filteredReportData = records.filter(r => {
        // æ—¥æœŸç­›é€‰
        if ((startDate && r.date < startDate) || (endDate && r.date > endDate)) {
            return false;
        }
        
        // ç±»å‹ç­›é€‰
        if (typeFilter !== 'all' && r.type !== typeFilter) {
            return false;
        }
        
        // åˆ†ç±»ç­›é€‰
        if (categoryFilter !== 'all' && r.category !== categoryFilter) {
            return false;
        }
        
        return true;
    });
    
    // æ›´æ–°æ•°æ®è¡¨æ ¼
    updateReportTable();
}

// æ›´æ–°æŠ¥è¡¨è¡¨æ ¼
function updateReportTable() {
    const tableBody = document.getElementById('reportDataTable');
    tableBody.innerHTML = '';
    
    if (filteredReportData.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: #999;">æ²¡æœ‰åŒ¹é…çš„è®°å½•</td></tr>';
        return;
    }
    
    // æŒ‰æ—¥æœŸæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
    const sortedData = [...filteredReportData].sort((a, b) => {
        return new Date(b.date) - new Date(a.date);
    });
    
    sortedData.forEach(r => {
        const row = document.createElement('tr');
        row.className = `${r.type}-row`;
        
        row.innerHTML = `
            <td>${r.date}</td>
            <td>${r.type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º'}</td>
            <td>${r.category}</td>
            <td>${r.type === 'income' ? '+' : '-'}ï¿¥${r.amount.toFixed(2)}</td>
            <td>${r.description || '-'}</td>
        `;
        
        tableBody.appendChild(row);
    });
}

// å¯¼å‡ºåŠŸèƒ½å®ç°

// å¯¼å‡ºExcel
function exportExcel() {
    try {
        showLoading(true);
        
        // å‡†å¤‡æ•°æ®
        const data = filteredReportData.map(record => ({
            'æ—¥æœŸ': record.date,
            'ç±»å‹': record.type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º',
            'åˆ†ç±»': record.category,
            'é‡‘é¢': record.amount,
            'å¤‡æ³¨': record.description || ''
        }));
        
        // åˆ›å»ºå·¥ä½œç°¿å’Œå·¥ä½œè¡¨
        const worksheet = XLSX.utils.json_to_sheet(data);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'è®°è´¦æ•°æ®');
        
        // ç”ŸæˆExcelæ–‡ä»¶å¹¶ä¸‹è½½
        const today = new Date().toISOString().split('T')[0];
        XLSX.writeFile(workbook, `è®°è´¦æ•°æ®_${today}.xlsx`);
        
        showToast('Excelå¯¼å‡ºæˆåŠŸ');
    } catch (error) {
        console.error('å¯¼å‡ºExcelå¤±è´¥:', error);
        showToast('å¯¼å‡ºExcelå¤±è´¥: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

// å¯¼å‡ºPDFï¼ˆçº¯ä¸­æ–‡ç‰ˆæœ¬ - ä½¿ç”¨å›¾ç‰‡æ–¹å¼ï¼‰
function exportPDF() {
    try {
        showLoading(true);
        
        // åˆ›å»ºä¸€ä¸ªä¸“é—¨ç”¨äºPDFçš„ä¸´æ—¶div
        const tempDiv = document.createElement('div');
        tempDiv.style.cssText = `
            position: absolute;
            top: -10000px;
            left: -10000px;
            width: 800px;
            background: white;
            padding: 30px;
            font-family: 'å¾®è½¯é›…é»‘', 'Microsoft YaHei', Arial, sans-serif;
            font-size: 14px;
            line-height: 1.6;
            color: #333;
        `;
        
        // è®¡ç®—ç»Ÿè®¡æ•°æ®
        const totalIncome = filteredReportData
            .filter(r => r.type === 'income')
            .reduce((sum, r) => sum + r.amount, 0);
            
        const totalExpense = filteredReportData
            .filter(r => r.type === 'expense')
            .reduce((sum, r) => sum + r.amount, 0);
        
        const today = new Date();
        
        // åˆ›å»ºHTMLå†…å®¹
        tempDiv.innerHTML = `
            <div style="text-align: center; margin-bottom: 40px; border-bottom: 3px solid #4facfe; padding-bottom: 20px;">
                <h1 style="font-size: 32px; color: #4facfe; margin: 0 0 15px 0;">è®°è´¦æ•°æ®æŠ¥è¡¨</h1>
                <p style="font-size: 16px; color: #666; margin: 0;">ç”Ÿæˆæ—¶é—´ï¼š${today.getFullYear()}å¹´${today.getMonth()+1}æœˆ${today.getDate()}æ—¥ ${today.getHours()}:${today.getMinutes().toString().padStart(2,'0')}</p>
            </div>
            
            <div>
                <h2 style="font-size: 24px; color: #333; margin-bottom: 20px; border-left: 5px solid #4facfe; padding-left: 15px;">è¯¦ç»†è®°å½•</h2>
                <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                    <thead>
                        <tr style="background: #4facfe; color: white;">
                            <th style="padding: 15px 10px; text-align: center; border: 1px solid #ddd;">æ—¥æœŸ</th>
                            <th style="padding: 15px 10px; text-align: center; border: 1px solid #ddd;">ç±»å‹</th>
                            <th style="padding: 15px 10px; text-align: center; border: 1px solid #ddd;">åˆ†ç±»</th>
                            <th style="padding: 15px 10px; text-align: center; border: 1px solid #ddd;">é‡‘é¢</th>
                            <th style="padding: 15px 10px; text-align: center; border: 1px solid #ddd;">å¤‡æ³¨</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredReportData.map((record, index) => `
                            <tr style="background: ${index % 2 === 0 ? '#f9f9f9' : 'white'};">
                                <td style="padding: 12px 8px; text-align: center; border: 1px solid #ddd;">${record.date}</td>
                                <td style="padding: 12px 8px; text-align: center; border: 1px solid #ddd; color: ${record.type === 'income' ? '#51cf66' : '#ff6b6b'}; font-weight: bold;">
                                    ${record.type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º'}
                                </td>
                                <td style="padding: 12px 8px; text-align: center; border: 1px solid #ddd;">${record.category}</td>
                                <td style="padding: 12px 8px; text-align: right; border: 1px solid #ddd; color: ${record.type === 'income' ? '#51cf66' : '#ff6b6b'}; font-weight: bold; font-size: 16px;">
                                    ${record.type === 'income' ? '+' : '-'}ï¿¥${record.amount.toFixed(2)}
                                </td>
                                <td style="padding: 12px 8px; text-align: left; border: 1px solid #ddd;">${record.description || 'æ— '}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 40px; text-align: center; padding-top: 20px; border-top: 2px solid #eee;">
                <p style="color: #666; font-size: 16px;">å…± ${filteredReportData.length} æ¡è®°å½• | äº‘ç«¯è®°è´¦ç³»ç»Ÿ | ${today.getFullYear()}</p>
            </div>
        `;
        
        document.body.appendChild(tempDiv);
        
        // ä½¿ç”¨æµè§ˆå™¨æ‰“å°åŠŸèƒ½ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
        setTimeout(() => {
            // ç›´æ¥ä¸‹è½½ä¸ºHTMLæ–‡ä»¶ï¼Œç”¨æˆ·å¯ä»¥åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€åæ‰“å°ä¸ºPDF
            const htmlContent = `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è®°è´¦æŠ¥è¡¨</title>
    <style>
        body { font-family: 'å¾®è½¯é›…é»‘', 'Microsoft YaHei', Arial, sans-serif; margin: 0; padding: 20px; }
        @media print { body { margin: 0; } }
    </style>
</head>
<body>
    ${tempDiv.innerHTML}
</body>
</html>`;
            
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `è®°è´¦æŠ¥è¡¨_${today.toISOString().split('T')[0]}.html`;
            a.click();
            
            // æ¸…ç†
            document.body.removeChild(tempDiv);
            URL.revokeObjectURL(url);
            
            showToast('å·²ä¸‹è½½HTMLæ ¼å¼æŠ¥è¡¨ï¼Œè¯·åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€åæŒ‰Ctrl+Pæ‰“å°ä¸ºPDF');
        }, 100);
        
    } catch (error) {
        console.error('å¯¼å‡ºPDFå¤±è´¥:', error);
        showToast('å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

// å¯¼å‡ºJSONå¤‡ä»½ï¼ˆä¿®å¤ä¹±ç é—®é¢˜ï¼‰
function exportJSON() {
    try {
        showLoading(true);
        
        // åˆ›å»ºæ•°æ®å¤‡ä»½
        const backupData = {
            version: '1.0',
            exportDate: new Date().toISOString(),
            records: records
        };
        
        // åˆ›å»ºJSONå­—ç¬¦ä¸²ï¼ˆç¡®ä¿UTF-8ç¼–ç ï¼‰
        const jsonString = JSON.stringify(backupData, null, 2);
        
        // åˆ›å»ºBlobå¯¹è±¡ï¼Œæ˜ç¡®æŒ‡å®šUTF-8ç¼–ç 
        const blob = new Blob(['\uFEFF' + jsonString], { 
            type: 'application/json;charset=utf-8' 
        });
        
        // åˆ›å»ºä¸‹è½½é“¾æ¥
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const today = new Date().toISOString().split('T')[0];
        
        a.href = url;
        a.download = `è®°è´¦æ•°æ®å¤‡ä»½_${today}.json`;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        
        // æ¸…ç†
        setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }, 100);
        
        showToast('JSONå¤‡ä»½æˆåŠŸ');
    } catch (error) {
        console.error('å¯¼å‡ºJSONå¤±è´¥:', error);
        showToast('å¯¼å‡ºJSONå¤±è´¥: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

// å¯¼å…¥æ•°æ®
function importData() {
    const fileInput = document.getElementById('importFile');
    const file = fileInput.files[0];
    
    if (!file) {
        showToast('è¯·å…ˆé€‰æ‹©æ–‡ä»¶', 'error');
        return;
    }
    
    const reader = new FileReader();
    
    reader.onload = function(e) {
        try {
            showLoading(true);
            
            if (file.name.endsWith('.json')) {
                // å¯¼å…¥JSONæ•°æ®
                const importedData = JSON.parse(e.target.result);
                
                if (!importedData.records || !Array.isArray(importedData.records)) {
                    throw new Error('æ— æ•ˆçš„JSONæ ¼å¼');
                }
                
                // éªŒè¯æ•°æ®
                const isValid = importedData.records.every(item => 
                    item.id && item.type && item.amount && item.category && item.date
                );
                
                if (!isValid) {
                    throw new Error('æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                }
                
                if (confirm(`ç¡®å®šè¦å¯¼å…¥ ${importedData.records.length} æ¡è®°å½•å—ï¼Ÿè¿™å°†è¦†ç›–å½“å‰æ•°æ®ã€‚`)) {
                    records = importedData.records;
                    updateDisplay();
                    updateReportCategoryFilter();
                    showToast('æ•°æ®å¯¼å…¥æˆåŠŸ');
                }
            } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                // å¯¼å…¥Excelæ•°æ®
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                
                // è½¬æ¢æ•°æ®æ ¼å¼
                const importedRecords = jsonData.map((item, index) => ({
                    id: Date.now() + index,
                    type: item['ç±»å‹'] === 'æ”¶å…¥' ? 'income' : 'expense',
                    amount: parseFloat(item['é‡‘é¢']),
                    category: item['åˆ†ç±»'],
                    date: item['æ—¥æœŸ'],
                    description: item['å¤‡æ³¨'] || ''
                }));
                
                if (confirm(`ç¡®å®šè¦å¯¼å…¥ ${importedRecords.length} æ¡è®°å½•å—ï¼Ÿè¿™å°†è¦†ç›–å½“å‰æ•°æ®ã€‚`)) {
                    records = importedRecords;
                    updateDisplay();
                    updateReportCategoryFilter();
                    showToast('æ•°æ®å¯¼å…¥æˆåŠŸ');
                }
            } else {
                throw new Error('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼');
            }
        } catch (error) {
            console.error('å¯¼å…¥å¤±è´¥:', error);
            showToast('å¯¼å…¥å¤±è´¥: ' + error.message, 'error');
        } finally {
            showLoading(false);
            fileInput.value = '';
        }
    };
    
    // æ ¹æ®æ–‡ä»¶ç±»å‹é€‰æ‹©ä¸åŒçš„è¯»å–æ–¹å¼
    if (file.name.endsWith('.json')) {
        // ä½¿ç”¨UTF-8ç¼–ç è¯»å–JSONæ–‡ä»¶
        reader.readAsText(file, 'UTF-8');
    } else {
        reader.readAsArrayBuffer(file);
    }
}
</script>
</body>
</html>